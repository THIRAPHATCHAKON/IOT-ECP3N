#include <WiFi.h>
#include <WiFiManager.h>
#include <HTTPClient.h>


#define RESET_PIN 25   // ขา GPIO ที่ต่อกับปุ่ม Reset Wi-Fi (เช่น GPIO0)
int pin_1 = 16;
String apiKey = "07C1ZWVDLWKL7RQD"; //แก้เป็นของตัวเอง
const char* server = "http://api.thingspeak.com/update";


void setup() {
 Serial.begin(115200);
 delay(1000);
 Serial.println("\nStarting...");


 pinMode(RESET_PIN, INPUT_PULLUP);  // เปิด pull-up ภายใน
 pinMode(pin_1, OUTPUT);
 WiFiManager wm;


 // ตรวจสอบว่ามีการกดปุ่ม Reset Wi-Fi หรือไม่
 if (digitalRead(RESET_PIN) == LOW) {
   Serial.println("WiFi Reset Button Pressed!");
   wm.resetSettings();          // ล้างข้อมูล Wi-Fi เดิม
   delay(1000);
   ESP.restart();               // รีสตาร์ตเครื่อง
 }


 // เริ่มเชื่อมต่อ Wi-Fi โดยอัตโนมัติ
 bool res = wm.autoConnect("ESP32-SetupAP", "12345678");


 if (!res) {
   Serial.println("Failed to connect. Restarting...");
   ESP.restart();
 } else {
   Serial.println("WiFi Connected!");
   Serial.print("IP Address: ");
   Serial.println(WiFi.localIP());
 }
}


void loop() {
 if (WiFi.status() == WL_CONNECTED) {
   HTTPClient http;


   // จำลองข้อมูล Sensor
   float temperature = random(25, 35);
   float humidity = random(50, 80);


   String url = server + String("?api_key=") + apiKey +
                "&field1=" + String(temperature) +
                "&field2=" + String(humidity);


   http.begin(url);
   int httpResponseCode = http.GET();


   if (httpResponseCode > 0) {
     Serial.println("Data sent to ThingSpeak!");
     digitalWrite(pin_1, HIGH);
     delay(300);
     digitalWrite(pin_1, LOW);
   } else {
     Serial.println("Error sending data.");
   }


   http.end();
 } else {
   Serial.println("WiFi not connected!");
 }


 delay(20000); // ThingSpeak จำกัดให้ส่งข้อมูลทุก 15 วินาทีขึ้นไป
}









